<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨è‚¯å®šãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- è¨­å®šç”»é¢ -->
    <div id="setupScreen" class="screen active">
        <div class="setup-container">
            <div class="setup-header">
                <h1>âœ¨ ã‚ãªãŸå°‚ç”¨ãƒœãƒƒãƒˆè¨­å®š</h1>
                <p>ãƒœãƒƒãƒˆã‚’ã‚ãªãŸå¥½ã¿ã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¾ã—ã‚‡ã†</p>
            </div>

            <form id="setupForm" class="setup-form">
                <div class="form-group">
                    <label for="botName">ãƒœãƒƒãƒˆå</label>
                    <input type="text" id="botName" placeholder="e.g. ã‚ã„ã¡ã‚ƒã‚“" value="ã‚ã„ã¡ã‚ƒã‚“">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="botGender">æ€§åˆ¥</label>
                        <select id="botGender">
                            <option value="å¥³æ€§">å¥³æ€§</option>
                            <option value="ç”·æ€§">ç”·æ€§</option>
                            <option value="ä¸­æ€§">ä¸­æ€§</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="botAge">å¹´ä»£</label>
                        <select id="botAge">
                            <option value="10ä»£">10ä»£</option>
                            <option value="20ä»£" selected>20ä»£</option>
                            <option value="30ä»£">30ä»£</option>
                            <option value="40ä»£">40ä»£</option>
                            <option value="50ä»£ä»¥ä¸Š">50ä»£ä»¥ä¸Š</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="botLanguage">å£èª¿</label>
                    <select id="botLanguage">
                        <option value="æ•¬èª">æ•¬èª</option>
                        <option value="ä¸å¯§èª" selected>ä¸å¯§èª</option>
                        <option value="ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«">ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«</option>
                        <option value="ã‚ªã‚¿ã‚¯èª">ã‚ªã‚¿ã‚¯èª</option>
                        <option value="é–¢è¥¿å¼">é–¢è¥¿å¼</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="botHabits">è©±ã—æ–¹ã®ç‰¹å¾´</label>
                    <textarea id="botHabits" placeholder="e.g. ã‚ˆãçµµæ–‡å­—ã‚’ä½¿ã†, æ¨ã—æ´»ã«ã¤ã„ã¦ã®è©±ãŒå¥½ã, ãƒã‚¸ãƒ†ã‚£ãƒ–"></textarea>
                </div>

                <button type="button" class="btn btn-primary" id="startChatBtn">ãƒãƒ£ãƒƒãƒˆé–‹å§‹</button>
            </form>
        </div>
    </div>

    <!-- ãƒãƒ£ãƒƒãƒˆç”»é¢ -->
    <div id="chatScreen" class="screen">
        <div class="chat-container">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="chat-header">
                <div class="header-content">
                    <h1 id="botNameDisplay">ã‚ã„ã¡ã‚ƒã‚“</h1>
                    <p id="botStatusDisplay">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</p>
                </div>
                <button class="btn btn-small" id="resetBtn">è¨­å®šå¤‰æ›´</button>
            </div>

            <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div id="messageContainer" class="message-container"></div>

            <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->
            <div class="chat-input-area">
                <div class="input-wrapper">
                    <input 
                        type="text" 
                        id="userInput" 
                        placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." 
                        autocomplete="off"
                    >
                    <button type="button" class="btn-send" id="sendBtn">é€ä¿¡</button>
                </div>
                <p class="input-hint">ä½•ã‚’è©±ã—ã‹ã‘ã¦ã‚‚ãƒœãƒƒãƒˆãŒå¿œæ´ã—ã¦ãã‚Œã¾ã™ğŸ’•</p>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // ãƒ¡ã‚¤ãƒ³å‡¦ç†
        // ==========================================
        const setupScreen = document.getElementById('setupScreen');
        const chatScreen = document.getElementById('chatScreen');
        const setupForm = document.getElementById('setupForm');
        const startChatBtn = document.getElementById('startChatBtn');
        const resetBtn = document.getElementById('resetBtn');

        let botConfig = {
            name: 'ã‚ã„ã¡ã‚ƒã‚“',
            gender: 'å¥³æ€§',
            age: '20ä»£',
            language: 'ä¸å¯§èª',
            habits: ''
        };

        // è¨­å®šèª­ã¿è¾¼ã¿
        function loadConfig() {
            const saved = localStorage.getItem('botConfig');
            if (saved) {
                botConfig = JSON.parse(saved);
                applyConfig();
                switchToChat();
            }
        }

        // è¨­å®šã‚’é©ç”¨
        function applyConfig() {
            document.getElementById('botName').value = botConfig.name;
            document.getElementById('botGender').value = botConfig.gender;
            document.getElementById('botAge').value = botConfig.age;
            document.getElementById('botLanguage').value = botConfig.language;
            document.getElementById('botHabits').value = botConfig.habits;
            document.getElementById('botNameDisplay').textContent = botConfig.name;
        }

        // è¨­å®šä¿å­˜
        function saveConfig() {
            botConfig = {
                name: document.getElementById('botName').value || 'ã‚ã„ã¡ã‚ƒã‚“',
                gender: document.getElementById('botGender').value,
                age: document.getElementById('botAge').value,
                language: document.getElementById('botLanguage').value,
                habits: document.getElementById('botHabits').value
            };
            localStorage.setItem('botConfig', JSON.stringify(botConfig));
        }

        // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
        function switchToChat() {
            setupScreen.classList.remove('active');
            chatScreen.classList.add('active');
        }

        function switchToSetup() {
            chatScreen.classList.remove('active');
            setupScreen.classList.add('active');
            applyConfig();
        }

        // ãƒãƒ£ãƒƒãƒˆé–¢é€£
        const messageContainer = document.getElementById('messageContainer');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');

        function addMessage(text, sender) {
            const messageEl = document.createElement('div');
            messageEl.className = `message message-${sender}`;
            messageEl.innerHTML = `<div class="message-content">${escapeHtml(text)}</div>`;
            messageContainer.appendChild(messageEl);
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;

            addMessage(text, 'user');
            userInput.value = '';

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text, config: botConfig })
                });

                if (!response.ok) throw new Error('APIã‚¨ãƒ©ãƒ¼');
                const data = await response.json();
                addMessage(data.reply, 'bot');
            } catch (error) {
                console.error('ã‚¨ãƒ©ãƒ¼:', error);
                addMessage('ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“...ãªã‚“ã‹ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã¡ã‚ƒã£ãŸğŸ’¦', 'bot');
            }
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        startChatBtn.addEventListener('click', () => {
            saveConfig();
            switchToChat();
        });

        resetBtn.addEventListener('click', switchToSetup);

        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // åˆæœŸåŒ–
        loadConfig();
    </script>
</body>
</html>
